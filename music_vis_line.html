<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset='utf-8'>
    <meta content='width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0' name='viewport'>

    <title>Music Visualization</title>
    <link href='scripts/bootstrap-3.3.6-dist/css/bootstrap.min.css' rel='stylesheet' type='text/css'>
    <link href='scripts/dc.js/dc.css' rel='stylesheet' type='text/css'>
    <link href='scripts/d3/lib/colorbrewer/colorbrewer.css' rel='stylesheet' type='text/css'>
    <link href="scripts/jquery-ui-1.11.4.custom/jquery-ui.css" rel="stylesheet" type="text/css">
    <link href="scripts/Guriddo_jqGrid_JS_5/css/ui.jqgrid.css" rel="stylesheet" type="text/css">

    <script src='scripts/d3/d3.js' type='text/javascript'></script>
    <script src='scripts/crossfilter/crossfilter.js' type='text/javascript'></script>
    <script src='scripts/dc.js/dc.js' type='text/javascript'></script>
    <script src='scripts/jquery-2.2.3.js' type='text/javascript'></script>
    <script src='scripts/bootstrap-3.3.6-dist/js/bootstrap.min.js' type='text/javascript'></script>

    <script src='scripts/d3/lib/colorbrewer/colorbrewer.js' type='text/javascript'></script>
    <script src='scripts/jquery-ui-1.11.4.custom/jquery-ui.js' type='text/javascript'></script>
    <script src='scripts/Guriddo_jqGrid_JS_5/js/i18n/grid.locale-en.js' type='text/javascript'></script>
    <script src='scripts/Guriddo_jqGrid_JS_5/js/jquery.jqGrid.min.js' type='text/javascript'></script>
    <style type="text/css">
        body {
            font: 16px sans-serif;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .x.axis path {
            display: inline;
        }

        .line1, .line2 {
            fill: none;
            stroke-width: 3px;
        }
        .line1 {
          stroke: #F98229;
        }
        .line2 {
          stroke: #4AC2BC;
        }
        .y.axis path{
          display:none;
        }
        svg,.container {
        font: 12px 'Inconsolata',Monaco,"Lucida Console",Consolas,"Courier New";
        }
        .tick line{
          opacity: 0.1;
          stroke-width:1px;
        }
        .col-centered{
          float:none;
          margin: 0 auto;
        }
        .button2 {
          margin-left: auto;
          margin-right: auto;
        }

        #hourButton.active{
          color: white;
          background-color:black;
        }
        #weekButton.active{
          color:white;
          background-color:black;
        }

        nav {
          margin-left:auto;
          margin-right:auto;
        }


    </style>
</head>

<body>
  <nav class="navbar navbar-default">
   <div class="container-fluid">
     <!-- Brand and toggle get grouped for better mobile display -->


     <!-- Collect the nav links, forms, and other content for toggling -->
     <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1" style="font-size:14px;">
       <ul class="nav navbar-nav">
          <li><a href="/index.html">Listening behavior: Time <span class="sr-only">(current)</span></a></li>
          <li class="active"><a href="/webContent_new2/music_vis_line.html">Listening behavior: song attribute</a></li>
          <li><a href="/barchart.html">Device & Traffic source</a></li>
          <li><a href="/treemap">Song preference</a></li>
       </ul>
     </div><!-- /.navbar-collapse -->
   </div><!-- /.container-fluid -->
  </nav>

    <div class='container' id='main-container'>
        <div class='content'>
              <div class='container' style='font: 12px sans-serif;'>
                <div class='row'>
                   <div class="col-sm-12 col-md-12 col-lg-8 col-centered">
                    <h3 style="font-family:'Inconsolata',Monaco; margin-top:50px">Daily/Weekly Listening Behavior #2: Song attributes</h3>
                   </div>
                </div>
                <div class='row'>
                   <div style="font-size:14px;font-family:'Inconsolata',Monaco;" class="col-sm-8 col-md-8 col-lg-8 col-centered">
                     <p>Song attributes includes popularity, valence, familiarity, danceability:</p>
                     <p>From July to November in 2015, The songs user1 listens are stronger than user2's in almost all song attribute. <p>
                   </div>
                </div>
                <div class='row'>
                <div class="col-sm-12 col-md-12 col-lg-12">
                	<div  style="margin-top:40px;" class="row">
                    <div class="input-group col-sm-1 col-md-1 col-lg-1 center-block">
                        <div class="button2 input-group-btn">
                            <button id="hourButton" style = "border-color: grey;" type="button" class="btn active btn-default">by hours</button>
                            <button id="weekButton" style = "border-color: grey;" type="button"class="btn btn-default">by days</button>
                        </div>
                    </div>
                    </div>
                    </div>


                </div>
                <div class='row'>
                    <div class="col-sm-12 col-md-12 col-lg-12">
                        <div style = "margin-top:10%;margin-left: -6%;"class='col-sm-1 col-md-1 col-lg-1 pull-left'><button id="prevButton" type="button" class="btn btn-default"><< Previous attribute</button></div>
                        <div style="margin-top:30px" class='line-graph col-sm-10 col-md-10 col-lg-10 col-centered' id='line-chart'></div>
                        <div style = "margin-top: -23%" class='col-sm-1 col-md-1 col-lg-1 pull-right'><button id="nextButton" type="button" class="btn btn-default">Next attribute >></button></div>
                     </div>
                </div>
             <div>
        </div>





    </div>

    <script>
        var margin = {
                top: 40,
                right: 80,
                bottom: 30,
                left: 100
            },
            width = $("#line-chart").width() - margin.left - margin.right,
            height = width /
            2 - margin.top - margin.bottom;

        var zoom = d3.behavior.zoom()
        .scaleExtent([1, 1])
        .on("zoom", zoomed);
        var drag = d3.behavior.drag();

        var isLeapYear = function(d) {
            var year = d.getFullYear();
            if((year & 3) != 0) return false;
            return ((year % 100) != 0 || (year % 400) == 0);
        };

        // Get Day of Year
        var getDOY = function(d) {
            var dayCount = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
            var mn = d.getMonth();
            var dn = d.getDate();
            var dayOfYear = dayCount[mn] + dn;
            if(mn > 1 && isLeapYear(d)) dayOfYear++;
            return dayOfYear;
        };
        function getWeekOfYear(d) {
        	var wd=new Date(d);
        	wd.setHours(0,0,0);
            wd.setDate(wd.getDate()+4-(wd.getDay()||7));
            if(d.getDay() == wd.getDay()) return +Math.ceil((((d-new Date(d.getFullYear(),0,1))/8.64e7)+1)/7);
            else return 0;
        }

        var weekFormat = d3.time.format("%w");
		var weekStringFormat = d3.time.format("%a");

        function fixData(user, d) {
            var ot = d.timestamp;
            d.user = user;
            d.timestamp = parseDate(d.timestamp);
            if(!d.timestamp) {
                console.error("Invalid timestamp data " + ot);
                return;
            }
            if(isNaN(d.milliseconds_played)) {
                console.log("Invalid time played " + d.milliseconds_played);
                return;
            }
            d.hour = d.timestamp.getHours();
            d.weekDay = weekFormat(d.timestamp);
            //adjust to make Monday start of the week
            if(d.weekDay == 0) d.weekDay = 6;
            else d.weekDay -= 1;
            d.dayOfYear = getDOY(d.timestamp);
            d.weekOfYear = getWeekOfYear(d.timestamp);
        }
        var parseDate = d3.time.format("%Y/%m/%d %H:%M:%S").parse;

        var x = d3.time.scale().range([0, width]);

        var y = d3.scale.linear().range([height, 0]);

        var hourTickValues = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11,
             	             12, 13, 14, 15, 16, 17, 18, 19, 20,
            	             21, 22, 23, 24];
        function hourTickFormat(v) {
        	var s="";
        	if(v == 0) s = "12AM";
        	else if(v == 12) s = "Noon";
        	else if(v > 12) s = (v-12) + "";
        	else s=v;
        	return s;
        }
        var metrics = {
        			"hour": [
                       {name: "averageValenceScore", ylabel: "Average Valence Score"},
                       {name: "averageDanceabilityScore", ylabel: "Average Danceability"},
                       {name: "averageFamiliarityScore", ylabel: "Average Familiarity"},
                      {name: "averageRunnability", ylabel: "Average Runnability"},
                       {name: "averageEnergy", ylabel: "Average Energy"},
                       {name: "averagePopularityNormalized", ylabel: "Average Popularity"}
                       ],
                    "week":[
                        {name: "averageValenceScore", ylabel: "Average Valence Score"},
                        {name: "averageDanceabilityScore", ylabel: "Average Danceability"},
                        {name: "averageFamiliarityScore", ylabel: "Average Familiarity"},
                        {name: "averageRunnability", ylabel: "Average Runnability"},
                        {name: "averageEnergy", ylabel: "Average Energy"},
                        {name: "averagePopularityNormalized", ylabel: "Average Popularity"}
        				]
        			};
        var xDomainMap = {
        		"hour": [0, 24],
        		"week" : [0, 6]
        };
        var yDomain =  [0, 1];

        var weekTickValues = [ 0, 1, 2, 3, 4, 5, 6];
		    var weekTickStringValues = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
        function weekTickFormat(v) {
        	var s = weekTickStringValues[+v];
        	return s;
        }
        var showChartForMetric = null;
        var selectedIndex = 0;
        var xAxisType = "hour";

        $("#prevButton").on("click", function(evt) {
        	selectedIndex--;
        	if(selectedIndex < 0) selectedIndex = metrics[xAxisType].length-1;
        	else if(selectedIndex >= metrics[xAxisType].length) selectedIndex = 0;
        	if(metrics[xAxisType][selectedIndex]) showChartForMetric(metrics[xAxisType][selectedIndex]["name"], xAxisType);
        });
	    	$("#nextButton").on("click", function(evt) {

        	selectedIndex++;
        	if(selectedIndex < 0) selectedIndex = metrics[xAxisType].length-1;
        	else if(selectedIndex >= metrics[xAxisType].length) selectedIndex = 0;
        	if(metrics[xAxisType][selectedIndex]) showChartForMetric(metrics[xAxisType][selectedIndex]["name"], xAxisType);

        });

        $("#hourButton").on("click", function(evt) {
        	$("#hourButton").addClass("active");
        	$("#weekButton").removeClass("active");
        	xAxisType = "hour";
        	if(metrics[xAxisType][selectedIndex]) showChartForMetric(metrics[xAxisType][selectedIndex]["name"], "hour");
        });
		$("#weekButton").on("click", function(evt) {
        	$("#weekButton").addClass("active");
        	$("#hourButton").removeClass("active");
        	xAxisType = "week";
        	if(metrics[xAxisType][selectedIndex]) showChartForMetric(metrics[xAxisType][selectedIndex]["name"], "week");

        });
        var xAxis = d3.svg.axis().scale(x).orient("bottom")
        	.tickValues(hourTickValues
       		)
           .tickFormat(hourTickFormat);

        var yAxis = d3.svg.axis().scale(y).orient("left").innerTickSize(-width);

        var line = d3.svg.line().interpolate("basis").x(function(d) {
            return x(+d.key);
        }).y(function(d) {
            return y(+d.value.totalMilliseconds);
        });
		var vis = d3.select("#line-chart").append("svg").attr("width",
	            width + margin.left + margin.right).attr("height",
	                    height + margin.top + margin.bottom);

		var rect = vis.append("rect").attr("width", width)
				.attr("height", height)
				.attr("fill", "none")
				.style("pointer-events", "all")
				.call(drag).on("dblclick.zoom", null);
        var svg = vis.append("g").attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")")
            ;
        var lastXPos = 0;
		drag.on("drag", function() {
			lastXPos = d3.event.dx;
		});
        drag.on("dragend", function() {
        	  d3.event.sourceEvent.stopPropagation(); // silence other listeners
        	  if( lastXPos > 0 ) {
        		  selectedIndex++;
              	if(selectedIndex < 0) selectedIndex = metrics[xAxisType].length-1;
            	else if(selectedIndex >= metrics[xAxisType].length) selectedIndex = 0;
        		  if(metrics[xAxisType][selectedIndex]) showChartForMetric(metrics[xAxisType][selectedIndex]["name"], xAxisType);
        	  }
				else if(lastXPos < 0){
					selectedIndex--;
		        	if(selectedIndex < 0) selectedIndex = metrics[xAxisType].length-1;
		        	else if(selectedIndex >= metrics[xAxisType].length) selectedIndex = 0;
					if(metrics[xAxisType][selectedIndex]) showChartForMetric(metrics[xAxisType][selectedIndex]["name"], xAxisType);

				}
        	});

        function zoomed() {
				setTimeout(function() {
					if(d3.event.translate[0] > lastXPos) console.log("next");
					else console.log("previous");
					lastXPos = d3.event.translate[0];
				}, 500);
        }

		var crossfilterGroupsMap={};

       d3.csv("data/User1.csv", function(error, user1Data) {
            if(error)
                throw error;
            d3.csv("data/User2.csv", function(error, user2Data) {
                if(error)
                    throw error;
                var data = []; //consolidated user data
                //just join the user data for now
                //TODO will need to account for songs that cross hour boundaries

                user1Data.forEach(fixData.bind(undefined, "User1"));
                user2Data.forEach(fixData.bind(undefined, "User2"));
				data = user1Data.concat(user2Data);

                var facts = crossfilter(data); // Gets our 'facts' into crossfilter
				var hourMap = d3.map(data, function(d) {
					return d.hour;
				});
                var weekDayMap = d3.map(data, function(d) {
                	return d.weekDay;
                });
                var dayExtent = d3.extent(data, function(d) {
                	return d.dayOfYear;
                });
                var weekExtent = d3.extent(data, function(d) {
                	return d.weekOfYear;
                });
                var all = facts.groupAll();
				var userDimension = facts.dimension(function(d) {
					return d.user;
				});
				function addGroupRecord(p, v) {
                    ++p.number;
                    p.user = v.user;
                    p.totalMilliseconds += +v.milliseconds_played;
                    p.totalValenceScoreSong += v.valence_score;
                    p.totalValenceScore += (v.milliseconds_played * ((!v.valence_score || v.valence_score == "null") ? 0 : +v.valence_score));
                    p.totalDanceabilityScoreSong += v.danceability_score;
                    p.totalDanceabilityScore += (v.milliseconds_played * ((!v.danceability_score || v.danceability_score == "null") ? 0 : +v.danceability_score));
                    p.totalFamiliarityScoreSong += v.familiarity_score;
                    p.totalFamiliarityScore += (v.milliseconds_played * ((!v.familiarity_score || v.familiarity_score == "null") ? 0 : +v.familiarity_score));
                    p.totalSongTempoSong += v.song_tempo;
                    p.totalSongTempo += (v.milliseconds_played * ((!v.song_tempo || v.song_tempo == "null") ? 0 : +v.song_tempo));
                    p.totalRunnabilitySong += v.runnability;
                    p.totalRunnability += (v.milliseconds_played * ((!v.runnability || v.runnability == "null") ? 0 : +v.runnability));
                    p.totalEnergySong += v.energy;
                    p.totalEnergy += (v.milliseconds_played * ((!v.energy || v.energy == "null") ? 0 : +v.energy));
                    p.totalPopularityNormalizedSong += v.popularity_normalized;
                    p.totalPopularityNormalized += (v.milliseconds_played * ((!v.popularity_normalized || v.popularity_normalized == "null") ? 0 : +v.popularity_normalized));
                    return p;
                }
                function removeGroupRecord(p, v) {
                    --p.number;
                    p.user = v.user;
                    p.totalMilliseconds -= +v.milliseconds_played;
                    p.totalValenceScoreSong -= v.valence_score;
                    p.totalValenceScore -= (v.milliseconds_played * ((!v.valence_score || v.valence_score == "null") ? 0 : +v.valence_score));
                    p.totalDanceabilityScoreSong -= v.danceability_score;
                    p.totalDanceabilityScore -= (v.milliseconds_played * ((!v.danceability_score || v.danceability_score == "null") ? 0 : +v.danceability_score));
                    p.totalFamiliarityScoreSong -= v.familiarity_score;
                    p.totalFamiliarityScore -= (v.milliseconds_played * ((!v.familiarity_score || v.familiarity_score == "null") ? 0 : +v.familiarity_score));
                    p.totalSongTempoSong -= v.song_tempo;
                    p.totalSongTempo -= (v.milliseconds_played * ((!v.song_tempo || v.song_tempo == "null") ? 0 : +v.song_tempo));
                    p.totalRunnabilitySong -= v.runnability;
                    p.totalRunnability -= (v.milliseconds_played * ((!v.runnability || v.runnability == "null") ? 0 : +v.runnability));
                    p.totalEnergySong -= v.energy;
                    p.totalEnergy -= (v.milliseconds_played * ((!v.energy || v.energy == "null") ? 0 : +v.energy));
                    p.totalPopularityNormalizedSong -= v.popularity_normalized;
                    p.totalPopularityNormalized -= (v.milliseconds_played * ((!v.popularity_normalized || v.popularity_normalized == "null") ? 0 : +v.popularity_normalized));
                    return p;
                }
                function initGroup() {
                    return {
                        number: 0,
                        totalMilliseconds: 0,
                        totalValenceScore: 0,
                        totalDanceabilityScore: 0,
                        totalFamiliarityScore: 0,
                        totalSongTempo: 0,
                        totalRunnability: 0,
                        totalEnergy: 0,
                        totalPopularityNormalized: 0,
                        totalValenceScoreSong: 0,
                        totalDanceabilityScoreSong: 0,
                        totalFamiliarityScoreSong: 0,
                        totalSongTempoSong: 0,
                        totalRunnabilitySong: 0,
                        totalEnergySong: 0,
                        totalPopularityNormalizedSong: 0
                    }
                }

                function getSummaryDataForUser(filteredData, xdim) {
                	var filteredFacts = crossfilter(filteredData);
                	var hourDimension = filteredFacts.dimension(function(d) {
                        return d.hour;
                    });
                    var weekDayDimension = filteredFacts.dimension(function(d) {
                        return d.weekDay;
                    });


                    var hourGroup = hourDimension.group().reduce(
                    		addGroupRecord, removeGroupRecord, initGroup);
                    crossfilterGroupsMap["hour"] = hourGroup;

                    var weekDayGroup = weekDayDimension.group().reduce(
                    		addGroupRecord, removeGroupRecord, initGroup);
                    crossfilterGroupsMap["week"] = weekDayGroup;
                    userDimension.filter(null);
                    var allData = crossfilterGroupsMap[xdim].top(Infinity);
                    if(xdim == "hour" || xdim == "week") {
                    	var missing=[];
                    	var l=24;
                    	if(xdim == "week") l=6;
                    	var zeroData={};
                    	for(var  i=0; i<= l; i++) {
                    		var found=false;
                    		allData.forEach(function(d) {
                    			if(d.key == i) {
                    				found=true;
                    				//console.log("found "+d.key);
                    			}
                    			if(d.key == 0) zeroData = d;
                    		});
                    		if(!found && i != 24) missing.push(i);

                    	}
                    	missing.forEach(function(d) {
                    		allData.push({"key": d, "value": {
                    			totalMilliseconds: 0,
                                totalValenceScore: 0,
                                totalDanceabilityScore: 0,
                                totalFamiliarityScore: 0,
                                totalSongTempo: 0,
                                totalRunnability: 0,
                                totalEnergy: 0,
                                totalPopularityNormalized: 0,
                                totalValenceScoreSong: 0,
                                totalDanceabilityScoreSong: 0,
                                totalFamiliarityScoreSong: 0,
                                totalSongTempoSong: 0,
                                totalRunnabilitySong: 0,
                                totalEnergySong: 0,
                                totalPopularityNormalizedSong: 0
                                } });
                    	});
                    	if(xdim == "hour") {
                    		allData.push({"key": 24, "value": zeroData["value"] ? zeroData["value"] :
                    		{
                    			totalMilliseconds: 0,
                                totalValenceScore: 0,
                                totalDanceabilityScore: 0,
                                totalFamiliarityScore: 0,
                                totalSongTempo: 0,
                                totalRunnability: 0,
                                totalEnergy: 0,
                                totalPopularityNormalized: 0,
                                totalValenceScoreSong: 0,
                                totalDanceabilityScoreSong: 0,
                                totalFamiliarityScoreSong: 0,
                                totalSongTempoSong: 0,
                                totalRunnabilitySong: 0,
                                totalEnergySong: 0,
                                totalPopularityNormalizedSong: 0
                            }
                    		});
                    	}
                    }
                    return allData.sort(sortByHourAscending);
                }


                function sortByHourAscending(a, b) {
                    // Dates will be cast to numbers automagically:
                    return +a.key - (b.key);
                }


                var xAxisSvg = svg.append("g").attr("class", "x axis").attr("transform",
                    "translate(0," + height + ")").call(xAxis);

                var yAxisSvg = svg.append("g").attr("class", "y axis").call(yAxis);
                var yAxisText = yAxisSvg.append("text")
                    .attr("transform", "rotate(0)").attr("x",380).attr("y", -32).attr("dy",
                        ".71em").style("text-anchor", "middle").text("Current attribute: "+
                      		 metrics["hour"][0].ylabel + " (0~1)");
                var line1Svg = svg.append("path");
                line1Svg.datum([])
                .attr("class", "line1")//.style("stroke", function(d) {
                // 	return color("User1");
                // })
                .attr("d", line);

                var line2Svg = svg.append("path");
                line2Svg.datum([])
                .attr("class", "line2")//.style("stroke", function(d) {
                // 	return color("User2");
                // })
                .attr("d", line);

                var line1Text = svg.append("text")
                .datum([])
                .attr("class", "label")
                .attr("transform", "translate(0,0)")
                .attr("x", 3)
                .attr("dy", ".35em")
                .text("");
                		var line2Text = svg.append("text")
                        .datum([])
                        .attr("class", "label")
                        .attr("transform", "translate(0,0)")
                        .attr("x", 3)
                        .attr("dy", ".35em")
                        .text("");
				var firstTime = true;
                //this function is assigned to variable in global scope
                 showChartForMetric = function(metric, xdim) {
                	userDimension.filter("User1");
                    var u1Data = getSummaryDataForUser(userDimension.top(Infinity), xdim);
                    var factor=1;
                     if(xdim == "hour") {
                    	factor = dayExtent[1]-dayExtent[0];
                    } else {
                    	factor = weekExtent[1]-weekExtent[0];
                    }
                    var totalMetric=metric;
                    if(metric.match(/^average/)) {
                    	totalMetric = "total"+metric.substring(7);
                    } else {
                    	factor = 1;
                    }
                    userDimension.filter("User2");
                    var u2Data = getSummaryDataForUser(userDimension.top(Infinity), xdim);
                    console.log(u2Data);
                    users = [{
                        name: "User1",
                        values: u1Data
                    }, {
                        name: "User2",
                        values: u2Data
                    }];

                	userDimension.filter(null);

                    var group = crossfilterGroupsMap[xdim];
                    var fullData=group.top(Infinity);



                    if(totalMetric != metric) {
                    	var metricMin = d3.min(fullData, function(d) {
                    		if(metric != "averageMilliseconds" && d.value.totalMilliseconds == 0) return 0;
                    		if(metric == "averageMilliseconds")
                    			return d.value[totalMetric]/factor;
                            return d.value[totalMetric]/(d.value.totalMilliseconds);
                        });
                        var metricMax = d3.max(fullData, function(d) {
                        	if(metric != "averageMilliseconds" && d.value.totalMilliseconds == 0) return 0;
                        	if(metric == "averageMilliseconds")
                    			return d.value[totalMetric]/factor;
                            return d.value[totalMetric]/(d.value.totalMilliseconds);
                        });
                       // y.domain([0, metricMax*1.3]);
                       y.domain(yDomain);
                        x.domain(xDomainMap[xdim]);
                		line = d3.svg.line().interpolate("basis").x(function(d) {
                        	return x(+d.key);
                    	}).y(function(d) {
                   			if(d.value.totalMilliseconds == 0) return y(0);
                   			if(metric == "averageMilliseconds")
                				return y(+d.value[totalMetric]/factor);
                        	return y((+d.value[totalMetric]/(d.value.totalMilliseconds)));
                    	});
                    } else {
                    	var metricMin = d3.min(fullData, function(d) {
                            return d.value[metric];
                        });
                        var metricMax = d3.max(fullData, function(d) {
                            return d.value[metric];
                        });
                       // y.domain([0, metricMax*1.3]);
                       y.domain(yDomain);
                        x.domain(xDomainMap[xdim]);
                		line = d3.svg.line().interpolate("basis").x(function(d) {
                        	return x(+d.key);
                    	}).y(function(d) {
                        	return y(+d.value[metric]);
                    	});
                    }
                    if(xdim == "hour") {
                    	xAxis.tickValues(hourTickValues).tickFormat(hourTickFormat);
                    } else {
                    	xAxis.tickValues(weekTickValues).tickFormat(weekTickFormat)
                    }
                    if(firstTime) {
                    	xAxisSvg.call(xAxis);
                    } else {

	                    xAxisSvg
	                    .transition().duration(500).ease("sin-in-out")  // https://github.com/mbostock/d3/wiki/Transitions#wiki-d3_ease
	                    .call(xAxis);
                    }
                	var t0 = svg.transition().duration(750);
                    line1Svg
                .datum(u1Data);
                    line2Svg.datum(u2Data);
                    t0.selectAll(".line1").attr("d", line).attr("class", "line1");
                    t0.selectAll(".line2").attr("d", line).attr("class", "line2");


		                if(totalMetric != metric) {

		                	line1Text
		                    .datum(u1Data[u1Data.length - 1])
		                    .attr("class", "label")
		                    .attr("transform", function(d) {
	                        	if(metric == "averageMilliseconds")
	                        		return "translate(" + x(+d.key) + "," +
	                                y((+d.value[totalMetric]/(factor))) + ")";
	                        	if(d.value.totalMilliseconds == 0)
	                        		return "translate(" + x(+d.key) + "," +y(0)+ ")";
	                            return "translate(" + x(+d.key) + "," +
	                                y((+d.value[totalMetric]/(d.value.totalMilliseconds))) + ")";
	                        })
		                    .attr("x", 3)
		                    .attr("dy", ".35em")
		                    .text("User1");
		                	line2Text
		                    .datum(u2Data[u2Data.length - 1])
		                    .attr("class", "label")
		                    .attr("transform", function(d) {
	                        	if(metric == "averageMilliseconds")
	                        		return "translate(" + x(+d.key) + "," +
	                                y((+d.value[totalMetric]/(factor))) + ")";
	                        	if(d.value.totalMilliseconds == 0)
	                        		return "translate(" + x(+d.key) + "," +y(0)+ ")";
	                            return "translate(" + x(+d.key) + "," +
	                                y((+d.value[totalMetric]/(d.value.totalMilliseconds))) + ")";
	                        })
		                    .attr("x", 3)
		                    .attr("dy", "-.35em")
		                    .text("User2");

                  } else {

                	  line1Text
	                    .datum(u1Data[u1Data.length - 1])
	                    .attr("class", "label")
	                    .attr("transform", function(d) {
                          return "translate(" + x(+d.key) + "," +
                          y((+d.value[metric])) + ")";
                  })
	                    .attr("x", 3)
	                    .attr("dy", ".35em")
	                    .text("User2");

                	  line2Text
	                    .datum(u2Data[u2Data.length - 1])
	                    .attr("class", "label")
	                    .attr("transform", function(d) {
                            return "translate(" + x(+d.key) + "," +
                            y((+d.value[metric])) + ")";
                    })
	                    .attr("x", 3)
	                    .attr("dy", "-.35em")
	                    .text("User2");
                    }

                    if(firstTime) {
                    	yAxisSvg.call(yAxis);
                    	firstTime = false;
                    } else {

	                    var m=metrics[xdim];
	                    var ylabel = metrics["hour"][0].ylabel;

	                    m.forEach(function(d) {
	                    	if(d.name == metric) ylabel=d.ylabel;
	                    });
	                    yAxisText.text("Current attribute: " + ylabel + " (0~1)");
                    }

                }

                 showChartForMetric(metrics["hour"][0].name, "hour");

            }); //User2 data
        }); //User1 data
    </script>
</body>

</html>
